name: Build and Release APK

on:
  push:
    tags:
      - 'v*' # è§¦å‘æ¡ä»¶ï¼šæ¨é€ v1.0.0 è¿™æ ·çš„ tag

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write # å…è®¸åˆ›å»º Release

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # è·å–å®Œæ•´å†å²ï¼Œç”¨äºç”Ÿæˆ changelog

      # 2. è®¾ç½® JDK 17
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      # 3. è§£ç ç­¾åå¯†é’¥
      - name: Decode Keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > $GITHUB_WORKSPACE/release.keystore

      # 4. è®¾ç½®ç­¾åç¯å¢ƒå˜é‡
      - name: Set up signing config
        run: |
          echo "KEYSTORE_FILE=$GITHUB_WORKSPACE/release.keystore" >> $GITHUB_ENV
          echo "KEYSTORE_PASSWORD=${{ secrets.KEYSTORE_PASSWORD }}" >> $GITHUB_ENV
          echo "KEY_ALIAS=${{ secrets.KEY_ALIAS }}" >> $GITHUB_ENV
          echo "KEY_PASSWORD=${{ secrets.KEY_PASSWORD }}" >> $GITHUB_ENV

      # 5. è®¾ç½®ç‰ˆæœ¬å·ç¯å¢ƒå˜é‡
      - name: Set version environment variables
        run: |
          # Extract version from tag (remove 'v' prefix)
          VERSION_NAME=${{ github.ref_name }}
          VERSION_NAME=${VERSION_NAME#v}
          echo "VERSION_NAME=$VERSION_NAME" >> $GITHUB_ENV

          # Generate versionCode from tag (major*10000 + minor*100 + patch)
          # e.g., v1.3.3 -> 10303
          VERSION=$VERSION_NAME
          IFS='.' read -ra VERSION_PARTS <<< "$VERSION"
          MAJOR=${VERSION_PARTS[0]:-0}
          MINOR=${VERSION_PARTS[1]:-0}
          PATCH=${VERSION_PARTS[2]:-0}
          VERSION_CODE=$((MAJOR * 10000 + MINOR * 100 + PATCH))
          echo "VERSION_CODE=$VERSION_CODE" >> $GITHUB_ENV
          echo "Version: $VERSION_NAME, Code: $VERSION_CODE"

      # 6. èµ‹äºˆ gradlew æ‰§è¡Œæƒé™
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # 7. ç¼–è¯‘ Release APKï¼ˆå·²ç­¾åï¼‰
      - name: Build Release APK
        run: ./gradlew assembleRelease --stacktrace --no-daemon --parallel

      # 8. é‡å‘½å APK
      - name: Rename APK
        run: |
          VERSION_NAME=${{ github.ref_name }}
          mv app/build/outputs/apk/release/app-release.apk \
             TaskWizard-${VERSION_NAME}.apk

      # 9. è®¡ç®— SHA256 æ ¡éªŒå’Œ
      - name: Calculate SHA256
        id: sha256
        run: |
          SHA256=$(sha256sum TaskWizard-${{ github.ref_name }}.apk | awk '{print $1}')
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT
          echo "SHA256: $SHA256"

      # 10. ç”Ÿæˆåˆ†ç±» Changelog
      - name: Generate Changelog
        id: changelog
        run: |
          # è·å–ä¸Šä¸€ä¸ª tag
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -z "$PREVIOUS_TAG" ]; then
            COMMIT_RANGE="HEAD"
          else
            COMMIT_RANGE="${PREVIOUS_TAG}..HEAD"
          fi

          # åˆå§‹åŒ–å„åˆ†ç±»
          FEATURES=""
          FIXES=""
          DOCS=""
          REFACTOR=""
          PERF=""
          CHORE=""
          OTHER=""

          # éå†æäº¤å¹¶åˆ†ç±»
          while IFS= read -r commit; do
            if [[ $commit == feat:* ]] || [[ $commit == feat\(* ]]; then
              FEATURES="${FEATURES}- ${commit}\n"
            elif [[ $commit == fix:* ]] || [[ $commit == fix\(* ]]; then
              FIXES="${FIXES}- ${commit}\n"
            elif [[ $commit == docs:* ]] || [[ $commit == docs\(* ]]; then
              DOCS="${DOCS}- ${commit}\n"
            elif [[ $commit == refactor:* ]] || [[ $commit == refactor\(* ]]; then
              REFACTOR="${REFACTOR}- ${commit}\n"
            elif [[ $commit == perf:* ]] || [[ $commit == perf\(* ]]; then
              PERF="${PERF}- ${commit}\n"
            elif [[ $commit == chore:* ]] || [[ $commit == chore\(* ]]; then
              CHORE="${CHORE}- ${commit}\n"
            else
              OTHER="${OTHER}- ${commit}\n"
            fi
          done < <(git log $COMMIT_RANGE --pretty=format:"%s (%h)" --no-merges)

          # æ„å»º Changelog
          CHANGELOG=""

          if [ -n "$FEATURES" ]; then
            CHANGELOG="${CHANGELOG}### âœ¨ æ–°åŠŸèƒ½\n${FEATURES}\n"
          fi

          if [ -n "$FIXES" ]; then
            CHANGELOG="${CHANGELOG}### ğŸ› Bug ä¿®å¤\n${FIXES}\n"
          fi

          if [ -n "$REFACTOR" ]; then
            CHANGELOG="${CHANGELOG}### ğŸ¨ ä»£ç ä¼˜åŒ–\n${REFACTOR}\n"
          fi

          if [ -n "$PERF" ]; then
            CHANGELOG="${CHANGELOG}### âš¡ æ€§èƒ½ä¼˜åŒ–\n${PERF}\n"
          fi

          if [ -n "$DOCS" ]; then
            CHANGELOG="${CHANGELOG}### ğŸ“ æ–‡æ¡£\n${DOCS}\n"
          fi

          if [ -n "$CHORE" ]; then
            CHANGELOG="${CHANGELOG}### ğŸ”§ å…¶ä»–\n${CHORE}\n"
          fi

          if [ -n "$OTHER" ]; then
            CHANGELOG="${CHANGELOG}### ğŸ“¦ å…¶ä»–æ›´æ–°\n${OTHER}\n"
          fi

          # å¦‚æœæ²¡æœ‰ä»»ä½•æäº¤ï¼Œæ·»åŠ é»˜è®¤ä¿¡æ¯
          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="é¦–æ¬¡å‘å¸ƒ"
          fi

          # è¾“å‡ºåˆ° GitHub Actions
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo -e "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # 11. åˆ›å»º GitHub Release
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: TaskWizard-${{ github.ref_name }}.apk
          body: |
            ## ğŸš€ TaskWizard ${{ github.ref_name }}

            ### ğŸ“¦ ä¸‹è½½

            **APK æ–‡ä»¶ï¼š** [TaskWizard-${{ github.ref_name }}.apk](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/TaskWizard-${{ github.ref_name }}.apk)

            **SHA256 æ ¡éªŒå’Œï¼š**
            ```
            ${{ steps.sha256.outputs.sha256 }}
            ```

            ---

            ### ğŸ“ æ›´æ–°æ—¥å¿—

            ${{ steps.changelog.outputs.changelog }}

            ---

            ### âš™ï¸ ç³»ç»Ÿè¦æ±‚

            - Android 8.0 (API 26) æˆ–æ›´é«˜ç‰ˆæœ¬
            - éœ€è¦å®‰è£… [Shizuku](https://github.com/RikkaApps/Shizuku)
            - éœ€è¦å®‰è£… [ADB Keyboard](https://github.com/senzhk/ADBKeyBoard)ï¼ˆç”¨äºæ–‡æœ¬è¾“å…¥ï¼‰

            ### ğŸ“– ä½¿ç”¨è¯´æ˜

            è¯¦ç»†ä½¿ç”¨è¯´æ˜è¯·æŸ¥çœ‹ [é¡¹ç›®æ–‡æ¡£](https://github.com/${{ github.repository }})
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 12. æ¸…ç†ç­¾åå¯†é’¥
      - name: Cleanup
        if: always()
        run: |
          rm -f $GITHUB_WORKSPACE/release.keystore
